# SPDX-FileCopyrightText: 2026 PN5180-tagomatic contributors
# SPDX-License-Identifier: GPL-3.0-or-later

name: Arduino CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  format:
    name: Check Arduino Format
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Arduino CLI
        uses: arduino/setup-arduino-cli@v1
      
      - name: Install clang-format
        run: sudo apt-get update && sudo apt-get install -y clang-format
      
      - name: Check sketch formatting
        run: |
          # Find all .ino files and check formatting
          find sketch -name "*.ino" -exec clang-format --dry-run --Werror {} +
  
  build:
    name: Build Arduino Sketch
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        board:
          - fqbn: "arduino:mbed_rp2040:pico"
            platform: "arduino:mbed_rp2040"
            name: "Raspberry Pi Pico"
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Arduino CLI
        uses: arduino/setup-arduino-cli@v1
      
      - name: Install platform
        run: |
          arduino-cli config init
          arduino-cli core update-index
          arduino-cli core install ${{ matrix.board.platform }}
      
      - name: Install SimpleRPC library
        run: |
          arduino-cli lib install simpleRPC
          arduino-cli lib install FastLED
      
      - name: Compile sketch for ${{ matrix.board.name }}
        run: |
          arduino-cli compile --fqbn ${{ matrix.board.fqbn }} sketch/pn5180_reader
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sketch-${{ matrix.board.name }}
          path: sketch/pn5180_reader/build/
